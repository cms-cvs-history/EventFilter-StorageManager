set TIMESTAMP = `date '+%Y%m%d%H%M%S'`
set RUNNUMBER_TIMESTAMP = `date '+%y%m%d%H%M' | sed 's/^0//'`
#set RUNNUMBER_TIMESTAMP = "7031240"


rm -f $STMGR_DIR/cfg/tmp.tmp
cat $STMGR_DIR/cfg/sm_autobu_8fu.xml | sed "s/\(<runNumber.*>\).*\(<\/runNumber>\)/\1${RUNNUMBER_TIMESTAMP}\2/" > $STMGR_DIR/cfg/tmp.tmp
mv $STMGR_DIR/cfg/tmp.tmp $STMGR_DIR/cfg/sm_autobu_8fu.xml


cd $STMGR_DIR/log/builderUnit
xdaq.exe -h STMGR_DEV_BU_HOST -p STMGR_DEV_BU_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& BU${TIMESTAMP}.log &

sleep 3

cd $STMGR_DIR/log/filterUnit
xdaq.exe -h STMGR_DEV_FU_HOST -p STMGR_DEV_FU_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& FU${TIMESTAMP}.log &
sleep 3
if ($?SMDEV_FU_PROCESS_COUNT) then
  if ($SMDEV_FU_PROCESS_COUNT > 1) then
    xdaq.exe -h STMGR_DEV_FU2_HOST -p STMGR_DEV_FU2_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& FU${TIMESTAMP}_2.log &
    sleep 3
  endif
endif
if ($?SMDEV_FU_PROCESS_COUNT) then
  if ($SMDEV_FU_PROCESS_COUNT > 2) then
    xdaq.exe -h STMGR_DEV_FU3_HOST -p STMGR_DEV_FU3_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& FU${TIMESTAMP}_3.log &
    sleep 3
  endif
endif
if ($?SMDEV_FU_PROCESS_COUNT) then
  if ($SMDEV_FU_PROCESS_COUNT > 3) then
    xdaq.exe -h STMGR_DEV_FU4_HOST -p STMGR_DEV_FU4_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& FU${TIMESTAMP}_4.log &
    sleep 3
  endif
endif
if ($?SMDEV_FU_PROCESS_COUNT) then
  if ($SMDEV_FU_PROCESS_COUNT > 4) then
    xdaq.exe -h STMGR_DEV_FU5_HOST -p STMGR_DEV_FU5_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& FU${TIMESTAMP}_5.log &
    sleep 3
  endif
endif
if ($?SMDEV_FU_PROCESS_COUNT) then
  if ($SMDEV_FU_PROCESS_COUNT > 5) then
    xdaq.exe -h STMGR_DEV_FU6_HOST -p STMGR_DEV_FU6_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& FU${TIMESTAMP}_6.log &
    sleep 3
  endif
endif
if ($?SMDEV_FU_PROCESS_COUNT) then
  if ($SMDEV_FU_PROCESS_COUNT > 6) then
    xdaq.exe -h STMGR_DEV_FU7_HOST -p STMGR_DEV_FU7_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& FU${TIMESTAMP}_7.log &
    sleep 3
  endif
endif
if ($?SMDEV_FU_PROCESS_COUNT) then
  if ($SMDEV_FU_PROCESS_COUNT > 7) then
    xdaq.exe -h STMGR_DEV_FU8_HOST -p STMGR_DEV_FU8_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& FU${TIMESTAMP}_8.log &
    sleep 3
  endif
endif

cd $STMGR_DIR/log/storageManager
xdaq.exe -h STMGR_DEV_SM_HOST -p STMGR_DEV_SM_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& SM${TIMESTAMP}.log &

sleep 5

cd $STMGR_DIR/log/smProxy
xdaq.exe -h STMGR_DEV_SMPROXY_HOST -p STMGR_DEV_SMPROXY_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& PROXY${TIMESTAMP}.log &

sleep 5

cd $STMGR_DIR/log/consFU
xdaq.exe -h STMGR_DEV_CONSFU_HOST -p STMGR_DEV_CONSFU_PORT -c $STMGR_DIR/cfg/sm_autobu_8fu.xml >& CONS${TIMESTAMP}.log &

sleep 5

cd $STMGR_DIR/soap
./startupSystem.csh
